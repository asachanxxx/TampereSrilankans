Complete Backend Architecture Specification

Project: Event Management App
Stack: Next.js (App Router) + Supabase
Deployment: Vercel (Frontend + API) + Supabase (DB + Auth)
Environment: Free tier optimized

---

# 1Ô∏è‚É£ Overall Architecture

We are NOT building a traditional backend server.

Architecture:

Browser
‚Üí Vercel (Next.js UI + API routes if needed)
‚Üí Supabase (PostgreSQL + Auth + RLS)

Rules:

‚Ä¢ No separate Node/Express server
‚Ä¢ No microservices
‚Ä¢ No container deployment to Supabase
‚Ä¢ Supabase is primary backend
‚Ä¢ Next.js API routes used only for protected business logic

---

# 2Ô∏è‚É£ Project Structure (Must Follow Exactly)

Frontend root is:

```
src/event-ui
```

Backend logic must live inside this project.

Final structure:

```
src/event-ui
  /app
  /backend
    /services
    /repositories
    /policies
    /validators
  /models
  /config
  /lib
```

---

# 3Ô∏è‚É£ Folder Responsibilities

## `/backend/services`

Business logic layer.

Must include:
‚Ä¢ EventService
‚Ä¢ RegistrationService
‚Ä¢ TicketService
‚Ä¢ AdminService

Services:

* Contain business rules
* Call repositories
* Perform validations
* Enforce role checks

No database calls allowed directly from UI.

---

## `/backend/repositories`

Data access layer.

Responsibilities:
‚Ä¢ All Supabase queries
‚Ä¢ No business logic
‚Ä¢ Return typed models
‚Ä¢ Handle mapping from DB rows to domain models

UI and services must never directly query Supabase.

---

## `/backend/policies`

Define access rules:
‚Ä¢ isAdmin(user)
‚Ä¢ canEditEvent(user, event)
‚Ä¢ canViewPrivateEvent(user, event)

These are logical policy checks (separate from RLS).

---

## `/backend/validators`

Validate:
‚Ä¢ Event creation/update payload
‚Ä¢ Registration request
‚Ä¢ Ticket generation constraints
‚Ä¢ Enum IDs against JSON config

All input validation must happen here.

---

## `/models`

Shared domain models.

Must include:
‚Ä¢ Event
‚Ä¢ AppUser (with displayName)
‚Ä¢ Ticket
‚Ä¢ Registration

Models must be imported everywhere.
Types must not be duplicated.

---

## `/config`

Store enum definitions in JSON files:

‚Ä¢ event-statuses.json
‚Ä¢ event-visibility.json
‚Ä¢ event-categories.json

Database stores only string IDs.

Before insert/update:
Backend must validate that IDs exist in JSON config.

No database enum types allowed.

---

## `/lib`

Must contain:

‚Ä¢ Supabase client initializer
‚Ä¢ Server-side Supabase client helper
‚Ä¢ Utility helpers (date formatting, etc.)

Supabase client must be initialized in ONE place only.

---

# 4Ô∏è‚É£ Supabase Configuration Requirements

## Authentication

Enable:
‚Ä¢ Email/Password
‚Ä¢ Google OAuth
‚Ä¢ Facebook OAuth

Redirect URLs must include:
‚Ä¢ Local development
‚Ä¢ Production URL

---

## Profiles Table

Create `profiles` table:

Fields:
‚Ä¢ id (uuid, references auth.users.id)
‚Ä¢ display_name
‚Ä¢ role ('user' | 'admin')
‚Ä¢ created_at

Role must not be trusted from frontend.
Always verify from database.

---

# 5Ô∏è‚É£ Database Schema (Required Tables)

## events

Fields:
‚Ä¢ id
‚Ä¢ title
‚Ä¢ subtitle
‚Ä¢ event_date
‚Ä¢ start_at
‚Ä¢ end_at
‚Ä¢ location_name
‚Ä¢ city
‚Ä¢ short_description
‚Ä¢ description
‚Ä¢ cover_image_url
‚Ä¢ status_id
‚Ä¢ category_id
‚Ä¢ visibility_id
‚Ä¢ rating_average
‚Ä¢ rating_count
‚Ä¢ organizer_name
‚Ä¢ created_at

---

## event_registrations

Fields:
‚Ä¢ id
‚Ä¢ event_id (FK events.id)
‚Ä¢ user_id (FK auth.users.id)
‚Ä¢ registered_at

Constraints:
‚Ä¢ Unique (event_id, user_id)

---

## tickets

Fields:
‚Ä¢ id
‚Ä¢ event_id
‚Ä¢ user_id
‚Ä¢ ticket_number (unique)
‚Ä¢ issued_at

---

# 6Ô∏è‚É£ Row Level Security (Mandatory)

Enable RLS on:

‚Ä¢ events
‚Ä¢ event_registrations
‚Ä¢ tickets
‚Ä¢ profiles

Policies:

### events

‚Ä¢ Public can read where visibility_id = 'public'
‚Ä¢ Admin can read all
‚Ä¢ Only admin can insert/update/delete

### event_registrations

‚Ä¢ User can insert where user_id = auth.uid()
‚Ä¢ User can read only their own
‚Ä¢ Admin can read all

### tickets

‚Ä¢ User can read only their own
‚Ä¢ Admin can read all

### profiles

‚Ä¢ User can read/update own profile
‚Ä¢ Admin can read all

RLS must be tested before UI integration.

---

# 7Ô∏è‚É£ Service Layer Rules

Services must implement:

### EventService

‚Ä¢ listPublicEvents()
‚Ä¢ listUserEvents(userId)
‚Ä¢ getEventDetails(eventId)
‚Ä¢ createEvent(adminOnly)
‚Ä¢ updateEvent(adminOnly)

---

### RegistrationService

‚Ä¢ registerForEvent(userId, eventId)
‚Ä¢ Prevent duplicate registration
‚Ä¢ Automatically generate ticket

---

### TicketService

‚Ä¢ generateUniqueTicketNumber()
‚Ä¢ fetchUserTicket(userId, eventId)

---

# 8Ô∏è‚É£ API Route Strategy (If Required)

Create routes only when secure server-side execution is needed:

```
src/event-ui/app/api/events
src/event-ui/app/api/registrations
src/event-ui/app/api/admin
```

Each route must:
‚Ä¢ Validate session
‚Ä¢ Fetch user role
‚Ä¢ Call service layer
‚Ä¢ Return structured JSON

No business logic inside route files.

---

# 9Ô∏è‚É£ Docker Usage

Production:
‚Ä¢ No Docker deployment to Supabase
‚Ä¢ No Docker deployment to Vercel

Local development:
‚Ä¢ Optional Docker Compose
‚Ä¢ Can run Supabase local stack
‚Ä¢ Can run Next.js locally

Docker is development-only.

---

# üîü Free Tier Optimization Rules

Design must:
‚Ä¢ Avoid unnecessary joins
‚Ä¢ Use pagination
‚Ä¢ Avoid large selects
‚Ä¢ Avoid heavy polling
‚Ä¢ Cache public event list if needed

Keep operations lightweight.

---

# 11Ô∏è‚É£ Security Requirements

‚Ä¢ Never expose service_role key to frontend
‚Ä¢ Use anon public key in frontend only
‚Ä¢ Validate roles server-side
‚Ä¢ Never trust UI role state
‚Ä¢ Protect admin API routes

---

# 12Ô∏è‚É£ Migration Strategy

Database schema must be:
‚Ä¢ Version controlled
‚Ä¢ Managed via Supabase migration system
‚Ä¢ Stored in repo

Never manually modify production DB without migration tracking.

---

# 13Ô∏è‚É£ Deployment Flow

1. Push to GitHub
2. Vercel auto deploys frontend + API routes
3. Supabase hosts DB + Auth
4. Environment variables configured in Vercel
5. RLS policies verified

---

# 14Ô∏è‚É£ Definition of Done

Backend is considered complete when:

‚Ä¢ Supabase project configured
‚Ä¢ Tables created
‚Ä¢ RLS enabled and verified
‚Ä¢ Auth working (Email + Google + FB)
‚Ä¢ Profiles table linked
‚Ä¢ Roles enforced
‚Ä¢ Service layer clean
‚Ä¢ API routes protected
‚Ä¢ No business logic in UI
‚Ä¢ No direct Supabase calls from UI for sensitive actions

---

# üöÄ Final Architecture

```
Browser
   ‚Üì
Vercel (Next.js UI + API routes)
   ‚Üì
Supabase (Postgres + Auth + RLS)
```

Everything contained inside:

```
src/event-ui
```

---

If you want next, I can generate:
‚Ä¢ A clean system architecture diagram
‚Ä¢ A production RLS checklist
‚Ä¢ Or a performance + scaling plan for 5,000 users üöÄ
